{% extends "base.html" %}
{% block content %}
<div id="streamlog" class="container-fluid overflow-auto">
    {% for line in log %}
    <div class="row px-3">{{line}}</div>
    {%endfor%}
    
</div>
{% endblock%}
{% block extrascripts %}
<script language="javascript">

$(function(){
    $('#main').addClass("d-none")
    $('#log').removeClass("d-none")
});

$('#log button').unbind();
$('#log button').click(function(){
    button_value = $(this).val();
    if (button_value == "downloadlog") {
        $.ajax({
            url: '{{url_for('main.log')}}',
            method: 'POST',
            data: JSON.stringify({"action": "downloadlog"}),
            contentType:"application/json; charset=utf-8", 
            xhrFields: {
                responseType: 'blob'
            },
            success: function (data) {
                var a = document.createElement('a');
                var url = window.URL.createObjectURL(data);
                a.href = url;
                a.download =  "viewrpicam-log";
                document.body.append(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            }
        });
    } else {
        callback = function(data) {location.reload();}
        queryData("POST", "{{url_for('main.log')}}", {'action': $(this).val()}, callback)
    }
    
});

function stream() {
    var source = new EventSource("{{ url_for('main.streamlog') }}");
    source.onmessage = function(event) {
        console.log(event.data)
        $('#streamlog').prepend('<div class="row px-3">'+event.data+'</div>');
    }
    source.onerror = (err) => {
    console.error("EventSource failed:", err);
    stream();
    };
}











function isFunction(functionToCheck) {
  return functionToCheck && {}.toString.call(functionToCheck) === '[object Function]';
}

function debounce(func, wait) {
    var timeout;
    var waitFunc;
    
    return function() {
        if (isFunction(wait)) {
            waitFunc = wait;
        }
        else {
            waitFunc = function() { return wait };
        }
        
        var context = this, args = arguments;
        var later = function() {
            timeout = null;
            func.apply(context, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, waitFunc());
    };
}

// reconnectFrequencySeconds doubles every retry
var reconnectFrequencySeconds = 1;
var evtSource;

var reconnectFunc = debounce(function() {
    setupEventSource();
    // Double every attempt to avoid overwhelming server
    reconnectFrequencySeconds *= 2;
    // Max out at ~1 minute as a compromise between user experience and server load
    if (reconnectFrequencySeconds >= 64) {
        reconnectFrequencySeconds = 64;
    }
}, function() { return reconnectFrequencySeconds * 1000 });

function setupEventSource() {
    evtSource = new EventSource("{{ url_for('main.streamlog') }}"); 
    evtSource.onmessage = function(e) {
      console.log(e.data)
    };
    evtSource.onopen = function(e) {
      // Reset reconnect frequency upon successful connection
      reconnectFrequencySeconds = 1;
    };
    evtSource.onerror = function(e) {
      evtSource.close();
      reconnectFunc();
    };
}
setupEventSource();
























</script>
{% endblock%}
