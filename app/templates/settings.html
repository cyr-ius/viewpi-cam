{% extends "base.html" %}
{% block content %}
<div class="container">
    <form id="form-settings" class="row needs-validation" action="{{ url_for('main.settings') }}" method="POST">
        <div class="row"><h4 class="p-0">Settings</h3></div>
        <hr class="p-0 ">    
        <div class="p-0 mt-1">Users buttons</div>
        {% for user_button in settings.user_buttons %}
        <div id="userbutton_{{loop.index}}" class="row row-cols-6 row-cols-md-6 g-1">
            <div class="col"><input class="form-control form-control-sm" type="text" name="name" placeholder="Name" value="{{user_button['name']}}"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="macro" placeholder="Macro" value="{{user_button['macro']}}"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="class" placeholder="Class" value="{{user_button['class']}}"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="style" placeholder="Style" value="{{user_button['style']}}"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="other" placeholder="Other" value="{{user_button['other']}}"></div>
            <div class="col"><button class="btn btn-sm btn-danger" type="button" onclick="del_row(this);"><i class="bi bi-dash-square-fill"></i></button></div>
        </div>
        {%endfor%}
        <div id="userbutton" class="row row-cols-6 row-cols-md-6 g-1">
            <div class="col"><input class="form-control form-control-sm" type="text" name="name" placeholder="Name"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="macro" placeholder="Macro"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="class" placeholder="Class"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="style" placeholder="Style"></div>
            <div class="col"><input class="form-control form-control-sm" type="text" name="other" placeholder="Other"></div>
            <div id="btn_add_button" class="col"><button class="btn btn-sm btn-success" type="button" id="add_button"><i class="bi bi-plus-square-fill"></i></button></div>
            <div id="btn_del_button" class="col d-none"><button class="btn btn-sm btn-danger" type="button" onclick="del_row(this);"><i class="bi bi-dash-square-fill"></i></button></div>
        </div>            
        <hr class="mt-3">
        <div class="p-0 m-0">Users</div>
        {% for user,values in settings.users.items() %}
        <div id="user_{{loop.index}}" class="row row-cols-4 row-cols-md-4 g-1">
            <div class="col"><input class="form-control form-control-sm" type="text" name="user" placeholder="user" value="{{user}}"></div>
            <div class="col"><input class="form-control form-control-sm" type="password" name="password" placeholder="password" onfocusout="$('#form-settings').trigger('submit');"></div>
            <div class="col">
                <select class="form-select form-select-sm" name="rights" onchange="$('#form-settings').trigger('submit');">
                    <option value="0" {% if values['rights'] == 0 %}selected {%endif%}>Minimum</option>
                    <option value="1" {% if values['rights'] == 1 %}selected {%endif%}>Minimum+</option>
                    <option value="2" {% if values['rights'] == 2 %}selected {%endif%}>Medium</option>
                    <option value="4" {% if values['rights'] == 4 %}selected {%endif%}>Max</option>        
                </select>
            </div>
            <div class="col"><button class="btn btn-sm btn-danger" type="button" onclick="del_row(this);"><i class="bi bi-dash-square-fill"></i></button></div>
        </div>
        {%endfor%}
        <div id="user" class="row row-cols-4 row-cols-md-4 g-1">
            <div class="col"><input class="form-control form-control-sm" type="text" name="user" placeholder="user"></div>
            <div class="col"><input class="form-control form-control-sm" type="password" name="password" placeholder="password"></div>
            <div class="col">
                <select class="form-select form-select-sm" name="rights">
                    <option value="0">Minimum</option>
                    <option value="1">Minimum+</option>
                    <option value="2">Medium</option>
                    <option value="4">Max</option>        
                </select>
            </div>
            <div id="btn_add_user" class="col"><button class="btn btn-sm btn-success" type="button" id="add_user"><i class="bi bi-plus-square-fill"></i></button></div>
            <div id="btn_del_user" class="col d-none"><button class="btn btn-sm btn-danger" type="button" onclick="del_row(this);"><i class="bi bi-dash-square-fill"></i></button></div>
        </div>            
        <hr class="mt-3">
        <div class="p-0 m-0">Token camera<p class="text-body-secondary">The generation of the token allows it to be passed as a parameter of the pages to avoid authentication. ex: {url}/?token=B123456</p></div>
        <div class="row row-cols-4 row-cols-md-4 g-1">
            <div class="col col-md-7">
                <div class="input-group">
                    <input id="token" class="form-control form-control-sm" type="text" name="token" value="{{settings.token}}" disabled>
                    <button id="copy" class="btn btn-sm btn-outline-secondary" type="button"><i class="bi bi-clipboard" aria-hidden="true"></i></button>
                    <button id="generate" class="btn btn-sm btn-outline-secondary" type="button">Generate</button>
                    <button id="reset" class="btn btn-sm btn-outline-secondary" type="button">Reset</button>
                </div>
            </div>
        </div>
        <hr class="mt-3">
        <div class="row row-cols-2 row-cols-md-2 g-1">
            <div class="col"><label class="form-check-label">Servo Blaster</label></div>
            <div class="col col-md-2">
                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" {% if settings.servo == 1%}checked{%endif%} name="servo" value="1" onchange="$('#form-settings').trigger('submit');"></div>
            </div>
        </div>
        <div class="row row-cols-2 row-cols-md-2 g-1">
            <div class="col"><label class="form-check-label">Pi Pan</label></div>
            <div class="col col-md-2">
                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" {% if settings.pipan == 1%}checked{%endif%} name="pipan" value="1" onchange="$('#form-settings').trigger('submit');"></div>
            </div>
        </div>
        <div class="row row-cols-2 row-cols-md-2 g-1">
            <div class="col"><label class="form-check-label">Pi Light</label></div>
            <div class="col col-md-2">
                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" {% if settings.pilight == 1%}checked{%endif%} name="pilight" value="1" onchange="$('#form-settings').trigger('submit');"></div>
            </div>
        </div>
        <hr class="mt-3">
        <div class="row row-cols-2 row-cols-md-2 g-1">
            <div class="col"><label class="form-check-label">U Preset</label></div>
            <div class="col col-md-2">
                <select class="form-select form-select-sm" name="upreset" onchange="$('#form-settings').trigger('submit');">
                    <option value="v2" {% if settings.upreset == 'v2' %}selected{%endif%}>v2</option>
                    <option value="N-IMX219" {% if settings.upreset == 'N-IMX219' %}selected{%endif%}>N-IMX219</option>
                    <option value="N-OV5647" {% if settings.upreset == 'N-OV5647' %}selected{%endif%}>N-OV5647</option>
                    <option value="P-IMX219" {% if settings.upreset == 'P-IMX219' %}selected{%endif%}>P-IMX219</option>
                    <option value="P-OV5647" {% if settings.upreset == 'P-OV5647' %}selected{%endif%}>P-OV5647</option>
                </select>
            </div>
        </div>        
    </form>    
</div>
{% endblock %}

{%block extrascripts%}
<script language="javascript">
var btns = {{ settings.user_buttons | length }} + 1;
var users = {{ settings.users | length }} + 1;

$(document).ready(function(){
    $('#main').addClass("d-none")
});

$('#generate').unbind();
$('#generate').click(function(){
    $.post('{{url_for('main.settings')}}', {'token':'generate'}, function(data){
        $('#token').val(data['token']);
    });
});

$('#reset').unbind();
$('#reset').click(function(){
    $.post('{{url_for('main.settings')}}', {'token':'reset'}, function(){
        $('#token').val('');
    });
});

$('#copy').unbind();
$('#copy').click(function(){
    copyToClipboard('#token');
});

$('#add_button').unbind();
$('#add_button').click(function(){
    button = $('#userbutton').clone();
    $(button).children('#btn_add_button').addClass('d-none');
    $(button).children('#btn_del_button').removeClass('d-none');
    $(button).prop("id","userbutton_"+users);
    button.insertBefore('#userbutton');
    $('#userbutton input').val('');
    $('#form-settings').trigger("submit");
    btns++;
});

$('#add_user').unbind();
$('#add_user').click(function(){
    rights = $('#user select[name="rights"]').find(':selected').val();
    user = $('#user').clone();
    $(user).children('#btn_add_user').addClass('d-none');
    $(user).children('#btn_del_user').removeClass('d-none');
    $(user).prop("id","user_"+users);
    user.insertBefore('#user');
    $('#user_'+users+' select[name="rights"]').val(rights);
    $('#user input').val('');
    $('#user select').val('0');    
    $('#form-settings').trigger("submit");
    users++;        
});

$('#form-settings').unbind();
$('#form-settings').on( "submit", function( event ) {
  $.post('{{url_for("main.settings")}}',$('#form-settings').serialize() )
  event.preventDefault();
});

function del_row(obj){
    id = $(obj).parent().parent().prop('id').split('_');
    num_id = parseInt(id[1]);
    str_id = id[0];
    $('#'+str_id+'_'+num_id).remove();
    $('#form-settings').trigger("submit");
}

function copyToClipboard(element) {
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val($(element).val()).select();
    document.execCommand("copy");
    $temp.remove();
}

</script>


{%endblock%}