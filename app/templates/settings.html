{% extends "base.html" %}
{% block content %}
<div class="container-fluid overflow-auto px-5 py-2">
    <div class="row">
        <div class="row"><h4 class="p-0">Settings</h3>
        </div>
        <hr class="p-0 ">
        <div class="row">Users buttons</div>
        <div id="ubuttons" class="row">
            {%for ubutton in settings.ubuttons%}
            <div id="ubuttons-{{ubutton.id}}" class="row row-cols-7 row-cols-md-7 g-1 ms-2 uchange">
                <input type="hidden" name="id" value="{{ubutton.id}}">
                <div class="col-auto">
                    <div class="form-check form-switch">
                        <input class="form-check-input" name="display" type="checkbox" {% if ubutton.display == 1 %}checked{%endif%}>
                    </div>
                </div>
                <div class="col"><input class="form-control form-control-sm" name="name" placeholder="Name" required="" type="text" value="{{ubutton.name}}" readonly></div>
                <div class="col"><input class="form-control form-control-sm" name="macro" placeholder="Macro" required="" type="text" value="{{ubutton.macro}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="css_class" placeholder="class" type="text" value="{{ubutton.css_class}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="style" placeholder="Style" type="text" value="{{ubutton.style}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="other" placeholder="Other" type="text" value="{{ubutton.other}}"></div>
                <div class="col" id="btn_del_button"><button class="btn btn-sm btn-danger del_button" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>
            {% endfor%}
            <div id="ubuttons-ref" class="row row-cols-7 row-cols-md-7 g-1 ms-2">
                <input type="hidden" name="id">
                <div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" name="display" type="checkbox"></div></div>
                <div class="col"><input class="form-control form-control-sm" name="name" placeholder="Name" required="" type="text"></div>
                <div class="col"><input class="form-control form-control-sm" name="macro" placeholder="Macro" required="" type="text"></div>
                <div class="col"><input class="form-control form-control-sm" name="css_class" placeholder="class" type="text"></div>
                <div class="col"><input class="form-control form-control-sm" name="style" placeholder="Style" type="text"></div>
                <div class="col"><input class="form-control form-control-sm" name="other" placeholder="Other" type="text"></div>
                <div class="col" id="btn_add_button"><button class="btn btn-sm btn-success add_button" type="button"><i class="bi bi-plus-square-fill"></i></button></div>
                <div class="col d-none" id="btn_del_button"><button class="btn btn-sm btn-danger del_button" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>
        </div>
        <hr class="mt-3">
        <div class="row">Users</div>
        <div id="users" class="row">
            {%for user in settings.users%}
            <div id="users-{{user.id}}" class="row row-cols-4 row-cols-md-4 g-1 ms-2 uchange">
                <input type="hidden" name="id" value="{{user.id}}">
                <div class="col"><input class="form-control form-control-sm" name="name" placeholder="Username" required="" type="text" value="{{user.name}}" readonly></div>
                <div class="col"><input class="form-control form-control-sm" name="password" onfocusout="$(this).trigger('submit');" placeholder="Password" type="password"></div>
                <div class="col">
                    <select class="form-select form-select-sm" name="rights" required>
                        <option {% if user.rights == 1 %}selected{%endif%} value="1">Minimum</option>
                        <option {% if user.rights == 2 %}selected{%endif%} value="2">Minimum+</option>
                        <option {% if user.rights == 4 %}selected{%endif%} value="4">Medium</option>
                        <option {% if user.rights == 8 %}selected{%endif%} value="8">Max</option>
                    </select>
                </div>
                <div class="col" id="btn_del_user"><button class="btn btn-sm btn-danger del_user" name="del_user" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>
            {%endfor%}
            <div id="users-ref" class="row row-cols-4 row-cols-md-4 g-1 ms-2">
                <input type="hidden" name="id">
                <div class="col"><input class="form-control form-control-sm" name="name" placeholder="Username" type="text" required></div>
                <div class="col"><input class="form-control form-control-sm" name="password" onfocusout="$(this).trigger('submit');" placeholder="Password" type="password" required></div>
                <div class="col">
                    <select class="form-select form-select-sm" name="rights" onchange="$(this).trigger('submit');" required>
                        <option value="1">Minimum</option>
                        <option value="2">Minimum+</option>
                        <option value="4">Medium</option>
                        <option value="8">Max</option>
                    </select>
                </div>
                <div class="col" id="btn_add_user"><button class="btn btn-sm btn-success add_user" name="add_user" type="button"><i class="bi bi-plus-square-fill"></i></button></div>
                <div class="col d-none" id="btn_del_user"><button class="btn btn-sm btn-danger del_user" name="del_user" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>
        </div>
        <hr class="mt-3">
        <div class="rows">
            Token camera<p class="text-body-secondary">The generation of the token allows it to be
            passed as a parameter of the pages to avoid authentication. ex: {url}/?token=B123456</p>
        </div>
        <div class="row">
            <div class="row row-cols-1 row-cols-md-1 g-1 ms-2">
                <div class="col col-md-8">
                    <div class="input-group">
                        <input class="form-control form-control-sm" disabled="disabled" id="token" name="token" type="text" value="{{settings.token}}">
                        <button class="btn btn-sm btn-outline-secondary" id="copy" name="copy" type="button"><i class="bi bi-clipboard"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" id="get_token" name="generate" type="button">Generate</button>
                        <button class="btn btn-sm btn-outline-secondary" id="del_token" name="reset" type="button">Reset</button>
                    </div>
                </div>
            </div>
        </div>
        <hr class="mt-3">
        <div class="row">
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-check-label" for="servo">Servo blaster</label></div>
                <div class="col col-md-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" id="servo" name="servo" type="checkbox" {% if settings.servo == 1 %}checked{%endif%}>
                    </div>
                </div>
            </div>
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-check-label" for="pipan">Pi Pan</label></div>
                <div class="col col-md-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" id="pipan" name="pipan" type="checkbox" {% if settings.pipan == 1 %}checked{%endif%}>
                    </div>
                </div>
            </div>
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-check-label" for="pilight">Pi Light</label></div>
                <div class="col col-md-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" id="pilight" name="pilight" type="checkbox" {% if settings.pilight == 1 %}checked{%endif%}>
                    </div>
                </div>
            </div>
            <hr class="mt-3">
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-label" for="upreset">UPreset</label></div>
                <div class="col col-md-4">
                    <select class="form-select form-select-sm" id="upreset" name="upreset">
                        <option {% if settings.upreset == "v2" %}selected{%endif%} value="v2">v2</option>
                        <option {% if settings.upreset == "N-IMX219" %}selected{%endif%} value="N-IMX219">N-IMX219</option>
                        <option {% if settings.upreset == "P-IMX219" %}selected{%endif%} value="P-IMX219">P-IMX219</option>
                        <option {% if settings.upreset == "N-OV5647" %}selected{%endif%} value="N-OV5647">N-OV5647</option>
                        <option {% if settings.upreset == "P-OV5647" %}selected{%endif%} value="P-OV5647">P-OV5647</option>
                    </select>
                </div>
            </div>
        </div>
        <hr class="mt-3">
        <div id="macros" class="row">
            {%for macro in config["MACROS"]%}
            <div class="row row-cols-4 row-cols-md-4 g-1 mb-2 uchange">
                <input type="hidden" name="name" value="{{macro|lower}}">
                <div class="col">Macro:{{macro}}</div>
                <div class="col col-md-2 text-center">
                    <input class="form-control-checkbox" type="checkbox" name="state"
                    {% if macros[macro][:1] == "-" %}
                        {% set value=macros[macro][1:] %}
                    {%else%}
                        {% set value=macros[macro] %}
                        checked="checked"
                    {%endif%}
                    ></div>
                <div class="col col-md-4"><input class="form-control form-control-sm" type="text" name="command" value="{{value}}"></div>
                <div class="col"><button class="btn btn-sm btn-outline-secondary" type="button" onclick="send_macroUpdate({{loop.index0}},'{{macro}}');">Execute</button></div>
            </div>
            {%endfor%}
        </div>
        <hr class="mt-3">
        <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
            <div class="col col-md-5"><label class="form-check-label" for="loglevel">Logging verbose</label></div>
            <div class="col col-md-4">
                <select class="form-select form-select-sm" id="loglevel" name="loglevel">
                    {% for item in ["INFO","WARNING","ERROR","DEBUG"]%}
                    <option {% if settings.loglevel == item %}selected{%endif%} value="{{item}}">{{item}}</option>
                    {%endfor%}
                </select>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{%block extrascripts%}
<script language="javascript">
    $(function () {
        $('#main').addClass("d-none")
    });

    $('#upreset, #pilight, #pipan, #servo, #loglevel').unbind()
    $('#upreset, #pilight, #pipan, #servo, #loglevel').on("change", function(event) {
        data = $(this).serializeObject({"checkboxesAsBools":true});
        $.queryData({"url":"{{ url_for('api.settings_sets')}}","data":data});
    })

    $('#copy').unbind();
    $('#copy').click(function () {
        copyToClipboard('#token');$.
        event.preventDefault();
    });

    $('#get_token').unbind();
    $('#get_token').click(function () {
        callback = function(data){$('#token').val(data["token"])}
        $.queryData({"url":"{{ url_for('api.settings_token')}}","callbackSuccess":callback});
    });

    $('#del_token').unbind();
    $('#del_token').click(function () {
        callback = function(data){$('#token').val('')}
        $.queryData({"method":"delete", "url":"{{ url_for('api.settings_token')}}","callbackSuccess":callback});
    });

    $('#users').on('click','.add_user', function() {
        user = $(this).parent().parent();
        data = $(user).find('input, select').serializeObject();
        let templ_user = $('#users-ref').clone();
        callback = function(data){
                user.find('#btn_add_user').addClass('d-none');
                user.find('#btn_del_user').removeClass('d-none');
                user.attr('id','users-'+data["id"]);
                user.addClass('uchange');
                $(user).find('input[name="name"]').attr("readonly","readonly");
                $(user).find('input[name="id"]').val(data["id"])
                $(templ_user).find('input').val('');
                templ_user.insertAfter(user);
        }
        $.queryData({"url":"{{ url_for('api.users_users')}}","data":data, "callbackSuccess":callback});

    });

    $('#users').on('click','.del_user', function() {
        user = $(this).parent().parent()
        data = $(user).find('input, select').serializeObject();
        callback = function(data){ user.remove() }
        $.queryData({"method":"delete", "url":`{{ url_for('api.users_users')}}/${data["id"]}`, "callbackSuccess":callback});
    });

    $('#users').on('change','.uchange', function(){
        let data = $(this).find('input, select, textarea').serializeObject({"checkboxesAsBools":true});
        $.queryData({"method":"put", "url":`{{ url_for('api.users_users')}}/${data["id"]}`, "data":data});
    });

    $('#ubuttons').on('click','.add_button', function() {
        button = $(this).parent().parent();
        data = $(button).find('input').serializeObject({"checkboxesAsBools":true});
        let templ_ubutton = $('#ubuttons-ref').clone();
        callback = function(data){
                button.find('#btn_add_button').addClass('d-none');
                button.find('#btn_del_button').removeClass('d-none');
                button.attr('id','ubuttons-'+data["id"]);
                button.addClass('uchange');
                $(button).find('input[name="name"]').attr("readonly","readonly");
                $(button).find('input[name="id"]').val(data["id"])
                $(templ_ubutton).find('input').val('');
                templ_ubutton.insertAfter(button);
        }
        $.queryData({"url":"{{ url_for('api.buttons_buttons')}}","data":data, "callbackSuccess":callback});
    });

    $('#ubuttons').on('click','.del_button', function() {
        button = $(this).parent().parent();
        data = $(button).find('input').serializeObject({"checkboxesAsBools":true});
        callback = function(data){ button.remove() }
        $.queryData({"method":"delete", "url":`{{ url_for('api.buttons_buttons')}}/${data["id"]}`, "callbackSuccess":callback});
    });

    $('#ubuttons').on('change','.uchange', function(){
        let data = $(this).find('input, select, textarea').serializeObject({"checkboxesAsBools":true});
        $.queryData({"method":"put", "url":`{{ url_for('api.buttons_buttons')}}/${data["id"]}`, "data":data});
    });

    $('#macros').on('change','.uchange', function(){
        let data = $(this).find('input, select, textarea').serializeObject({"checkboxesAsBools":true});
        console.log(data);
        $.queryData({"method":"post", "url":"{{ url_for('api.settings_macros')}}", "data":data});
    });

    function send_macroUpdate(i, macro) {
        var macrovalue = $('#'+macro).val();
        if(! $("#"+macro+"_chk").prop("checked")) {
            macrovalue = "-" + macrovalue;
        }
        $.sendCmd({'cmd':'um', 'params':[i.toString(), macrovalue]})
    }

    function copyToClipboard(element) {
        var $temp = $("<input>");
        $("body").append($temp);
        $temp.val($(element).val()).select();
        document.execCommand("copy");
        $temp.remove();
    }

</script>
{%endblock%}
