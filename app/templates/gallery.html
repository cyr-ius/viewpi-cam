{% extends "base.html" %}
{% block content %}
<div class="container-fluid overflow-auto">
    <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar" style="background-color:{{disk_usage[4]}};width: {{disk_usage[3]}}%"><span>local: {{disk_usage[3]}}%  Total: {{disk_usage[0]}} MB</span></div>
    </div>
    <div id="preview" class="d-none text-center">
        <span id="media-title"></span>
        <div id="media"></div>
    </div>
    <form id="form_gallery" action="{{ url_for('main.gallery') }}" method="POST">
        {% if thumbnails is iterable %}        
        <div class="row row-cols-1 g-4 my-1">
            <div class="col-auto">
                <div class="row">
                    <div class="col-2 px-1">
                        <label class="col-form-label-sm">Preview</label>
                    </div>
                    <div class="col-auto">
                        <input class="form-control form-control-sm" type="number" name="preview_size" value="{{preview_size}}">
                    </div>
                </div>
            </div>      
            <div class="col-auto">
                <div class="row">
                    <div class="col-3 px-1">
                        <label class="col-form-label-sm">Thumbnail</label>
                    </div>
                    <div class="col-auto">
                        <input class="form-control form-control-sm" type="number" name="thumb_size" value="{{thumb_size}}">
                    </div>
                </div>         
            </div>                                                 
            <div class="col-auto">
                <button class="btn btn-sm btn-primary" type="submit" name="action" value="updateSizeOrder">Update Size</button>
            </div>
            <div class="col-auto">
                <div class="row">
                    <div class="col-3 px-1">
                        <label class="col-form-label-sm">Ordering</label>
                    </div>
                    <div class="col-auto">
                        <select id="sort_order" class="form-select form-select-sm" name="sort_order" onchange="this.form.submit()">
                            <option value="1" {%  if sort_order|int == 1 %}selected{%endif%}>Ascending</option>
                            <option value="2" {%  if sort_order|int == 2 %}selected{%endif%}>Descending</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="row">
                    <div class="col-2 px-1">
                        <label class="col-form-label-sm">Types</label>
                    </div>
                    <div class="col-auto">
                        <select id="show_types" class="form-select form-select-sm" name="show_types" onchange="this.form.submit()">
                            <option value="1" {%  if show_types|int == 1 %}selected{%endif%}>Images &amp Videos</option>
                            <option value="2" {%  if show_types|int == 2 %}selected{%endif%}>Images only</option>
                            <option value="3" {%  if show_types|int == 3 %}selected{%endif%}>Videos only</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="row">
                    <div class="col-2 px-1">
                        <label class="col-form-label-sm">Filter</label>
                    </div>
                    <div class="col-auto">
                        <select id="time_filter" class="form-select form-select-sm" name="time_filter" onchange="this.form.submit()">
                            <option value="1" {%  if time_filter|int == 1 %}selected{%endif%}>All</option>
                            {% for i in range(2, time_filter_max)%}
                            <option value="{{i}}" {% if time_filter|int == i %}selected{%endif%}>{{(i-2) * 24}} - {{(i-1) * 24}} hours old</option>
                            {%endfor%}
                            <option value="{{time_filter_max}}" {% if time_filter|int == time_filter_max %}selected{%endif%} >{{(time_filter_max-2) * 24}} hours old</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3 my-1">
            {% for thumbnail in thumbnails%}
            <div class="col-auto">
                <div class='card shadow-sm'>
                    {% if thumbnail["file_size"] > 0 %}
                    <a id="load_preview" title="{{thumbnail['real_file']}}" href="#" onclick="load_preview('{{thumbnail['file_name']}}');">
                    {% endif%}
                    <img class="mx-auto d-block card-img-top" src="{{ url_for('static', filename=config['MEDIA']+'/'+thumbnail['file_name']) }}"/>
                    {% if thumbnail["file_size"] > 0 %}
                    </a>
                    {%endif%}
                    <div class="card-img-overlay" style="height:5px;">
                        <i class="float-start {{thumbnail['file_icon']}}" style="font-size: 16px;color: white;"></i>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Created {{ thumbnail.file_datetime.strftime('%Y-%m-%d') }} at {{thumbnail.file_datetime.strftime('%H:%M:%S') }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <input type="checkbox" class="btn-check" id="btn-check-1" checked="" autocomplete="off" name="check_list" {{select_all}} value="{{thumbnail.file_name}}">
                                <label class="btn btn-outline-light btn-sm" for="btn-check-1">Checked</label>
                                <button class="btn btn-outline-danger btn-sm" type="submit" name="delete1" value="{{thumbnail.file_name}}" onclick="return confirm('Are you sure you want to delete this file?');"><i class="bi bi-trash"></i>Delete</button>
                            </div>
                            {% if thumbnail["file_size"] > 0%}
                            <small class="text-body-secondary">
                            {% if thumbnail["file_size"] > 1024 %}{{ round(thumbnail["file_size"]/1024) }} MB {%else%} {{thumbnail["file_size"]}} KB {%endif%}
                            {{thumbnail["lapse_count"]}} {{thumbnail["duration"]}}
                            </small>
                            {% endif%}                    
                        </div>    
                    </div>
                </div>
            </div>
            {%endfor%}
        </div>   
        {%else%}
        <p>No videos/images saved</p>
        {%endif%}
        <input id="action" type="hidden" name="action" value="">
    </form>

</div>
{% endblock %}
{% block extrascripts %}
<script language="javascript">

var SUBDIR_CHAR = '{{g.config.subdir_char}}';
var next, prev;
var dict_thumbnails = {{thumbnails|tojson}};
var thumbnails = [];
$.each( dict_thumbnails, function( index, value ){ thumbnails[index]=value['file_name'];});
var linksBase = '{{url_for('main.gallery')}}?preview=';
var mediaBase = "static/{{config['MEDIA']}}/";
var previewWidth = {{preview_size}};
var preview_file = '{{preview_file}}';

(function() {
	document.onkeyup = function () {
		switch (event.keyCode) {
		case 39:
		    if (next) {
		    	load_preview(next);
		    }
		    break;
		case 37:
		    if (prev) {
		    	load_preview(prev);
		    }
		    break;
		}
	};
})();


$(document).ready(function(){
    $('#main').addClass("d-none")
    $('#gallery').removeClass("d-none")
    if (preview_file != ''){
        load_preview(preview_file);
    }
});

$('#gallery button').unbind();
$('#gallery button').click(function(){
    $("#action").val($(this).val())
    $("#form_gallery").trigger("submit");
    {# $.post("{{url_for('main.gallery')}}", {"action": $(this).val() }) #}
});

$('#display button').unbind();
$('#display button[name="download1"]').click(function(){
    var file_name = imageFromThumbnail($(this).val());
    $.ajax({
        url: '{{url_for('main.gallery')}}',
        method: 'POST',
        data: {"download1": $(this).val()},
        xhrFields: {
            responseType: 'blob'
        },
        success: function (data) {
            var a = document.createElement('a');
            var url = window.URL.createObjectURL(data);
            a.href = url;
            a.download =  file_name;
            document.body.append(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        }
    });

});

$('#display button[name="delete1"]').click(function(){
    $.post("{{url_for('main.gallery')}}", {"delete1": $(this).val() })
});

function fileTitle(thumbnailName) {
	return thumbnailName.substr(thumbnailName.length - suffixLength(thumbnailName) + 1).substr(0, suffixLength(thumbnailName) - 8);
}

function fileType(fileName) {
	var suffix = fileName.substr(-suffixLength(fileName));
	return suffix.substr(1, 1);
}

function fileExtension(fileName) {
	return fileName.split('.').pop();
}

function suffixLength(thumbnail) {
   return thumbnail.length - thumbnail.lastIndexOf(".", thumbnail.length - 8);
}

function imageFromThumbnail(thumbnailName) {
	var temp = thumbnailName.substr(0, thumbnailName.length - suffixLength(thumbnailName));
   return temp.split(SUBDIR_CHAR).join("/");
}

function preloadImage(url) {
    var _img = new Image();
    _img.src = url;
}

function load_preview(thumbnail) {
	history.pushState(null, null, linksBase + thumbnail);

	$("#gallery").addClass("d-none");
	$("#display").removeClass("d-none");
	$("#preview").removeClass("d-none");
	$('#media-title').html(fileTitle(thumbnail));
    $('#display button[name="download1"]').val(thumbnail);
    $('#display button[name="delete1"]').val(thumbnail);

	var imageIndex = thumbnails.indexOf(thumbnail);

	// Previous 
	if (imageIndex > 0) {
		prev = thumbnails[imageIndex-1];
        $('#display button[name="prev"]').prop('disabled', false);
        $('#display button[name="prev"]').unbind();
        $('#display button[name="prev"]').click(function(){load_preview(prev);});	
        if (fileExtension(imageFromThumbnail(prev)) == 'jpg') {
			preloadImage(mediaBase + imageFromThumbnail(prev));
		}
	} else {
		prev = null;
        $('#display button[name="prev"]').prop('disabled', true);
	}

	// Next
    console.log(imageIndex)
    console.log(thumbnails.length - 1)
	if (imageIndex >= 0 && imageIndex < thumbnails.length - 1) {
		next = thumbnails[imageIndex+1];
        $('#display button[name="next"]').prop('disabled', false);
        $('#display button[name="next"]').unbind();
        $('#display button[name="next"]').click(function(){load_preview(next);});
        if (fileExtension(imageFromThumbnail(next)) == 'jpg') {
			preloadImage(mediaBase + imageFromThumbnail(next));
		}
	} else {
		next = null;
        $('#display button[name="next"]').prop('disabled', true);
	}

	var mediaURL = mediaBase + imageFromThumbnail(thumbnail);
	if (mediaURL) {
		if (fileExtension(mediaURL) == 'jpg') {
			var media_content = '<a href="' + mediaURL + '" target="_blank"><img src="' + mediaURL + '" style="width: ' + previewWidth + 'px;"></a>';
		} else {
			var media_content = '<video style="width:' + previewWidth + 'px;" controls><source src="' + mediaURL + '" type="video/mp4">Your browser does not support the video tag.</video>';
		}
        $('#media').html(media_content);
	}
    console.log("ici")
	if (fileType(thumbnail) == 't') {
        $('#display button[name="convert"]').removeClass("d-none");
		$('#display button[name="convert"]').val(thumbnail);
	} else {
        $('#display button[name="convert"]').addClass("d-none");        
		$('#display button[name="convert"]').val();
	}
}

</script>
{% endblock%}