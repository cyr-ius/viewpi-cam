{% extends "base.html" %}
{% block content %}
<div class="container overflow-auto">
        <div class="row">
            <h4 class="p-0">Settings</h3>
        </div>
        <hr class="p-0 ">
        <div class="p-0 mt-1">Users buttons</div>
        <div id="ubuttons" class="row">
            {%for ubutton in settings.ubuttons%}
            <div class="row row-cols-6 row-cols-md-6 g-1 ms-2">
                <div class="col"><input class="form-control form-control-sm" name="name" placeholder="Name" required="" type="text" value="{{ubutton.name}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="macro" placeholder="Macro" required="" type="text" value="{{ubutton.macro}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="css_class" placeholder="class" type="text" value="{{ubutton.css_class}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="style" placeholder="Style" type="text" value="{{ubutton.style}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="other" placeholder="Other" type="text" value="{{ubutton.other}}"></div>
                <div class="col" id="btn_del_button"><button class="btn btn-sm btn-danger del_button" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>
            {% endfor%}
            <div id="ubuttons-ref" class="row row-cols-6 row-cols-md-6 g-1 ms-2">
                <div class="col"><input class="form-control form-control-sm" name="name" placeholder="Name" required="" type="text" value=""></div>
                <div class="col"><input class="form-control form-control-sm" name="macro" placeholder="Macro" required="" type="text" value=""></div>
                <div class="col"><input class="form-control form-control-sm" name="css_class" placeholder="class" type="text" value=""></div>
                <div class="col"><input class="form-control form-control-sm" name="style" placeholder="Style" type="text" value=""></div>
                <div class="col"><input class="form-control form-control-sm" name="other" placeholder="Other" type="text" value=""></div>
                <div class="col" id="btn_add_button"><button class="btn btn-sm btn-success add_button" type="button"><i class="bi bi-plus-square-fill"></i></button></div>
                <div class="col d-none" id="btn_del_button"><button class="btn btn-sm btn-danger del_button" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>
        </div>
        <hr class="mt-3">
        <div class="p-0 m-0">Users</div>
        <div id="users" class="row">
            {%for user in settings.users%}
            <div class="row row-cols-4 row-cols-md-4 g-1 ms-2">                
                <div class="col"><input class="form-control form-control-sm" name="user_id" placeholder="Username" required="" type="text" value="{{user.user_id}}"></div>
                <div class="col"><input class="form-control form-control-sm" name="password" onfocusout="$(this).trigger('submit');" placeholder="Password" type="password" value=""></div>
                <div class="col">
                    <select class="form-select form-select-sm" id="users-0-rights" name="rights" onchange="$(this).trigger('submit');" required="">
                        <option {% if user.rights == 1 %}selected{%endif%} value="1">Minimum</option>
                        <option {% if user.rights == 2 %}selected{%endif%} value="2">Minimum+</option>
                        <option {% if user.rights == 4 %}selected{%endif%} value="4">Medium</option>
                        <option {% if user.rights == 8 %}selected{%endif%} value="8">Max</option>
                    </select>
                </div>
                <div class="col" id="btn_del_user"><button class="btn btn-sm btn-danger del_user" name="del_user" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>
            {%endfor%}
            <div id="users-ref" class="row row-cols-4 row-cols-md-4 g-1 ms-2">                
                <div class="col"><input class="form-control form-control-sm" name="user_id" placeholder="Username" required type="text"></div>
                <div class="col"><input class="form-control form-control-sm" name="password" onfocusout="$(this).trigger('submit');" placeholder="Password" type="password" required></div>
                <div class="col">
                    <select class="form-select form-select-sm" id="users-0-rights" name="rights" onchange="$(this).trigger('submit');" required>
                        <option value="1">Minimum</option>
                        <option value="2">Minimum+</option>
                        <option value="4">Medium</option>
                        <option value="8">Max</option>
                    </select>
                </div>
                <div class="col" id="btn_add_user"><button class="btn btn-sm btn-success add_user" name="add_user" type="button"><i class="bi bi-plus-square-fill"></i></button></div>
                <div class="col d-none" id="btn_del_user"><button class="btn btn-sm btn-danger del_user" name="del_user" type="button"><i class="bi bi-dash-square-fill"></i></button></div>
            </div>                
        </div>
        <hr class="mt-3">
        <div class="p-0 m-0">Token camera<p class="text-body-secondary">The generation of the token allows it to be
                passed as a parameter of the pages to avoid authentication. ex: {url}/?token=B123456</p>
        </div>
        <div class="row">
            <div class="row row-cols-1 row-cols-md-1 g-1 ms-2">
                <div class="col col-md-8">
                    <div class="input-group">
                        <input class="form-control form-control-sm" disabled="disabled" id="token" name="token" type="text" value="{{settings.token}}">
                        <button class="btn btn-sm btn-outline-secondary" id="copy" name="copy" type="button"><i class="bi bi-clipboard"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" id="generate" name="generate" type="button">Generate</button>
                        <button class="btn btn-sm btn-outline-secondary" id="reset" name="reset" type="button">Reset</button>
                    </div>
                </div>
            </div>
        </div>
        <hr class="mt-3">
        <div class="row">
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-check-label" for="servo">Servo blaster</label></div>
                <div class="col col-md-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" id="servo" name="servo" type="checkbox" {% if settings.servo == 1 %}checked{%endif%}>
                    </div>
                </div>
            </div>
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-check-label" for="pipan">Pi Pan</label></div>
                <div class="col col-md-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" id="pipan" name="pipan" type="checkbox" {% if settings.pipan == 1 %}checked{%endif%}>
                    </div>
                </div>
            </div>
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-check-label" for="pilight">Pi Light</label></div>
                <div class="col col-md-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" id="pilight" name="pilight" type="checkbox" {% if settings.pilight == 1 %}checked{%endif%}>
                    </div>
                </div>
            </div>
            <hr class="mt-3">
            <div class="row row-cols-2 row-cols-md-2 g-1 ms-2">
                <div class="col col-md-5"><label class="form-label" for="upreset">UPreset</label></div>
                <div class="col col-md-4">
                    <select class="form-select form-select-sm" id="upreset" name="upreset">
                        <option {% if settings.upreset == "v2" %}selected{%endif%} value="v2">v2</option>
                        <option {% if settings.upreset == "N-IMX219" %}selected{%endif%} value="N-IMX219">N-IMX219</option>
                        <option {% if settings.upreset == "P-IMX219" %}selected{%endif%} value="P-IMX219">P-IMX219</option>
                        <option {% if settings.upreset == "N-OV5647" %}selected{%endif%} value="N-OV5647">N-OV5647</option>
                        <option {% if settings.upreset == "P-OV5647" %}selected{%endif%} value="P-OV5647">P-OV5647</option>
                    </select>
                </div>
            </div>
        </div>
        <hr class="mt-3"> 
        {%for macro in macros%}
        <div class="row row-cols-4 row-cols-md-4 g-1 mb-2">
            <div class="col">Macro:{{macro}}</div>
            <div class="col col-md-2 text-center">
                <input class="form-control-checkbox" type="checkbox" id="{{macro}}_chk"
                {% if raspiconfig[macro][:1] == "-" %}
                    {% set value=raspiconfig[macro][1:] %}
                    checked=""
                {%else%}
                    {% set value=raspiconfig[macro] %}
                    checked="checked"
                {%endif%}
                ></div>
            <div class="col col-md-4"><input class="form-control form-control-sm" type="text" id="{{macro|lower}}" value="{{value}}"></div>
            <div class="col"><button class="btn btn-sm btn-outline-secondary" type="button" onclick="send_macroUpdate({{loop.index0}},'{{macro}}');">OK</button></div>
        </div>
        {%endfor%}

</div>
{% endblock %}

{%block extrascripts%}
<script language="javascript">
    var templ_user = $('#users-ref').clone();
    var templ_ubutton = $('#ubuttons-ref').clone();

    function copyToClipboard(element) {
        var $temp = $("<input>");
        $("body").append($temp);
        $temp.val($(element).val()).select();
        document.execCommand("copy");
        $temp.remove();
    }



    $(function () {
        $('#main').addClass("d-none")
    }); 

    $('#upreset').unbind()
    $('#upreset').on("change", function(event) {
        data = $(this).serializeObject({"checkboxesAsBools":true});
        queryData("POST","{{ url_for('settings.index')}}",data);
    })

    $('#pilight, #pipan, #servo').unbind()
    $('#pilight, #pipan, #servo').on("change", function(event) {
        data = $(this).serializeObject({"checkboxesAsBools":true});
        console.log(data)
        queryData("POST","{{ url_for('settings.index')}}",data);
    })

    $('#copy').unbind();
    $('#copy').click(function () {
        copyToClipboard('#token');
        event.preventDefault();
    });

    $('#generate').unbind();
    $('#generate').click(function () {
        callback = function(data){$('#token').val(data["token"])}
        queryData("POST","{{ url_for('settings.index')}}",{"token":"generate"},callback);
    });     

    $('#reset').unbind();
    $('#reset').click(function () {
        callback = function(data){$('#token').val('')}
        queryData("DELETE","{{ url_for('settings.index')}}",{"token":"generate"},callback);
    });    

    $('#users').on('click','.add_user', function() {
        user = $(this).parent().parent()
        data = $(user).find('input, select').serializeObject()

        callback = function(data){
                user.find('#btn_add_user').addClass('d-none');
                user.find('#btn_del_user').removeClass('d-none');
                user.removeAttr('id')                
                templ_user.insertAfter(user);
        }
        queryData("POST","{{ url_for('settings.index')}}",data,callback);

    });

    $('#users').on('click','.del_user', function() {
        user = $(this).parent().parent()
        data = $(user).find('input, select').serializeObject();
        callback = function(data){ user.remove() }
        queryData("DELETE","{{ url_for('settings.index')}}",data,callback);
    });

    $('#ubuttons').on('click','.add_button', function() {
        button = $(this).parent().parent();
        data = $(button).find('input').serializeObject();
        callback = function(data){
                button.find('#btn_add_button').addClass('d-none');
                button.find('#btn_del_button').removeClass('d-none');
                button.removeAttr('id')                
                templ_ubutton.insertAfter(button);
        }
        queryData("POST","{{ url_for('settings.index')}}",data,callback);
    });

    $('#ubuttons').on('click','.del_button', function() {
        button = $(this).parent().parent();
        data = $(button).find('input').serializeObject();
        callback = function(data){ button.remove() }
        queryData("DELETE","{{ url_for('settings.index')}}",data,callback);
    });

    function send_macroUpdate(i, macro) {
        var macrovalue = $('#'+macro).val();        
        if(! $("#"+macro+"_chk").prop("checked")) {
            macrovalue = "-" + macrovalue;
        }
        send_cmd("um " + i + " " + macrovalue);
    }    

</script>
{%endblock%}