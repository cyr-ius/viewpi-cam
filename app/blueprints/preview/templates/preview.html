{% extends "base.html" %}
{% block content %}
<div class="container-fluid overflow-auto">
    <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar" style="background-color:{{disk_usage[4]}};width: {{disk_usage[3]}}%"><span>local: {{disk_usage[3]}}%  Total: {{disk_usage[0]}} MB</span></div>
    </div>
    <div id="preview" class="d-none text-center">
        <span id="media-title"></span>
        <div id="media"></div>
    </div>
    <form id="form_gallery" action="{{ url_for('preview.index') }}" method="POST">
        {% if thumbnails is iterable %}        
        <div class="row g-3 my-1">
            <div class="col-auto">
                <div class="row">
                    <div class="col-2 px-1">
                        <label class="col-form-label-sm">Preview</label>
                    </div>
                    <div class="col-auto">
                        <input class="form-control form-control-sm" type="number" name="preview_size" value="{{preview_size}}">
                    </div>
                </div>
            </div>      
            <div class="col-auto">
                <div class="row">
                    <div class="col-3 px-1">
                        <label class="col-form-label-sm">Thumbnail</label>
                    </div>
                    <div class="col-auto">
                        <input class="form-control form-control-sm" type="number" name="thumb_size" value="{{thumb_size}}">
                    </div>
                </div>         
            </div>                                                 
            <div class="col-auto">
                <button class="btn btn-sm btn-primary" type="button" name="updateSize" value="updateSizeOrder">Update Size</button>
            </div>
            <div class="col-auto">
                <div class="row">
                    <div class="col-3 px-1">
                        <label class="col-form-label-sm">Ordering</label>
                    </div>
                    <div class="col-auto">
                        <select id="sort_order" class="form-select form-select-sm" name="sort_order">
                            <option value="1" {%  if sort_order|int == 1 %}selected{%endif%}>Ascending</option>
                            <option value="2" {%  if sort_order|int == 2 %}selected{%endif%}>Descending</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="row">
                    <div class="col-2 px-1">
                        <label class="col-form-label-sm">Types</label>
                    </div>
                    <div class="col-auto">
                        <select id="show_types" class="form-select form-select-sm" name="show_types">
                            <option value="1" {%  if show_types|int == 1 %}selected{%endif%}>Images &amp Videos</option>
                            <option value="2" {%  if show_types|int == 2 %}selected{%endif%}>Images only</option>
                            <option value="3" {%  if show_types|int == 3 %}selected{%endif%}>Videos only</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="row">
                    <div class="col-2 px-1">
                        <label class="col-form-label-sm">Filter</label>
                    </div>
                    <div class="col-auto">
                        <select id="time_filter" class="form-select form-select-sm" name="time_filter">
                            <option value="1" {%  if time_filter|int == 1 %}selected{%endif%}>All</option>
                            {% for i in range(2, time_filter_max)%}
                            <option value="{{i}}" {% if time_filter|int == i %}selected{%endif%}>{{(i-2) * 24}} - {{(i-1) * 24}} hours old</option>
                            {%endfor%}
                            <option value="{{time_filter_max}}" {% if time_filter|int == time_filter_max %}selected{%endif%} >{{(time_filter_max-2) * 24}} hours old</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-6 row-cols-xl-8 g-3 my-1">
            {% for thumbnail in thumbnails%}
            <div class="col">
                <div class='card shadow-sm'>
                    {% if thumbnail["file_size"] > 0 %}
                    <a id="load_preview" title="{{thumbnail['real_file']}}" href="#" onclick="load_preview('{{thumbnail['file_name']}}');">
                    {% endif%}
                    <img class="mx-auto d-block card-img-top" src="{{ url_for('static', filename=config['MEDIA']+'/'+thumbnail['file_name']) }}"/>
                    {% if thumbnail["file_size"] > 0 %}
                    </a>
                    {%endif%}
                    <div class="card-img-overlay" style="height:5px;">
                        <i class="float-start {{thumbnail['file_icon']}}" style="font-size: 16px;color: white;"></i>
                        {% if not thumbnail.file_right %}
                        <i class="float-start bi bi-lock-fill" style="font-size: 16px;color: rgb(209, 182, 28);position: absolute;right: 5px;"></i>
                        {% endif %}
                    </div>
                    <div class="card-body">                  
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="btn-check-{{loop.index}}" name="check_list" {{select_all}} value="{{thumbnail.file_name}}">
                            <label class="form-check-label" for="{{thumbnail.file_name}}">Created {{ thumbnail.file_datetime.strftime('%Y-%m-%d') }} at {{thumbnail.file_datetime.strftime('%H:%M:%S') }}</label>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                             <button class="btn btn-outline-danger btn-sm" type="button" name="delete" value="{{thumbnail.file_name}}" {% if not thumbnail.file_right %}disabled{%endif%}><i class="bi bi-trash"></i>Delete</button>
                            {% if thumbnail["file_size"] > 0%}
                            <small class="text-body-secondary">
                            {% if thumbnail["file_size"] > 1024 %}{{ (thumbnail["file_size"]/1024) | round(2) }} MB {%else%} {{thumbnail["file_size"]}} KB {%endif%}
                            {{thumbnail["lapse_count"]}} {{thumbnail["duration"]}}s
                            </small>
                            {% endif%}                    
                        </div>    
                    </div>
                </div>
            </div>
            {%endfor%}
        </div>   
        {%else%}
        <p>No videos/images saved</p>
        {%endif%}
    </form>

</div>
{% endblock %}
{% block extrascripts %}
<script language="javascript">

let subdir_char = '{{raspiconfig.subdir_char}}';
let next, prev;
let dict_thumbnails = {{thumbnails|tojson}};
let thumbnails = [];
$.each( dict_thumbnails, function( index, value ){ thumbnails[index]=value['file_name'];});
let linksBase = '{{url_for('preview.index')}}?preview=';
let mediaBase = "/static/{{config['MEDIA']}}/";
let previewWidth = {{preview_size}};
let preview_file = '{{preview_file}}';

(function() {
	document.onkeyup = function () {
		switch (event.keyCode) {
		case 39:
		    if (next) {
		    	load_preview(next);
		    }
		    break;
		case 37:
		    if (prev) {
		    	load_preview(prev);
		    }
		    break;
		}
	};
})();

$(function(){
    $('#main').addClass("d-none")
    $('#gallery').removeClass("d-none")
    if (preview_file != ''){
        load_preview(preview_file);
    }
});

$('#form_gallery button[name="delete"], #display button[name="delete"').unbind()
$('#form_gallery button[name="delete"], #display button[name="delete"').click(function(){
    if (confirm('Are you sure you want to delete this file?')) {
        callback = function(data) {location.reload();}
        queryData("POST", "{{url_for('preview.index')}}", {"action":"delete", "filename": $(this).val()}, callback)
    }
})

$('#form_gallery button[name="updateSize"]').unbind()
$('#form_gallery button[name="updateSize"]').click(function(){
    confirm('Update Size'+this);
})

$('#time_filter, #show_types, #sort_order').on('change', function() {
    data = $('#form_gallery').serializeObject()
    callback = function(data) {location.reload();}
    queryData("POST", "{{url_for('preview.index')}}", data, callback)
})

$('#selectNone').unbind();
$('#selectNone').click(function(){
    $('#form_gallery input:checkbox').removeAttr('checked');
});

$('#selectAll').unbind();
$('#selectAll').click(function(){
    $('#form_gallery input:checkbox').attr('checked','checked');
});

$('#deleteSel, #lockSel, #unlockSel').unbind();
$('#deleteSel, #lockSel, #unlockSel').click(function(){
    callback = function(data) {location.reload();}
    data = $('#form_gallery').serializeObject();
    data.action = $(this).val()
    queryData("POST", "{{url_for('preview.index')}}", data, callback)    
});

$('#deleteAll').unbind();
$('#deleteAll').click(function(){
    if (confirm('Are you sure you want to delete all files ?')) {
        $('#form_gallery input:checkbox').attr('checked','checked');
        $('#deleteSel').trigger('click');
    }
});

$('#zipSel').unbind();
$('#zipSel').click(function(){
    data = $('#form_gallery').serializeObject();
    data.action = $(this).val()
    $.ajax({
        url: '{{url_for('preview.index')}}',
        method: 'POST',
        contentType:"application/json; charset=utf-8",   
        data: JSON.stringify(data),
        xhrFields: {
            responseType: 'blob'
        },
        success: function (data) {
            var a = document.createElement('a');
            var url = window.URL.createObjectURL(data);
            a.href = url;
            a.download =  "zipfile";
            document.body.append(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        }
    });

});

$('#display button').unbind();
$('#display button[name="download"]').click(function(){
    let file_name = imageFromThumbnail($(this).val());
    $.ajax({
        url: '{{url_for('preview.index')}}',
        method: 'POST',
        contentType:"application/json; charset=utf-8",   
        data: JSON.stringify({"action":"download", "filename": $(this).val()}),
        xhrFields: {
            responseType: 'blob'
        },
        success: function (data) {
            var a = document.createElement('a');
            var url = window.URL.createObjectURL(data);
            a.href = url;
            a.download =  file_name;
            document.body.append(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        }
    });

});

function fileTitle(thumbnailName) {
	return thumbnailName.substr(thumbnailName.length - suffixLength(thumbnailName) + 1).substr(0, suffixLength(thumbnailName) - 8);
}

function fileType(fileName) {
	var suffix = fileName.substr(-suffixLength(fileName));
	return suffix.substr(1, 1);
}

function fileExtension(fileName) {
	return fileName.split('.').pop();
}

function suffixLength(thumbnail) {
   return thumbnail.length - thumbnail.lastIndexOf(".", thumbnail.length - 8);
}

function imageFromThumbnail(thumbnailName) {
	var temp = thumbnailName.substr(0, thumbnailName.length - suffixLength(thumbnailName));
   return temp.split(subdir_char).join("/");
}

function preloadImage(url) {
    var _img = new Image();
    _img.src = url;
}

function load_preview(thumbnail) {
	history.pushState(null, null, linksBase + thumbnail);

	$("#gallery").addClass("d-none");
	$("#display").removeClass("d-none");
	$("#preview").removeClass("d-none");
	$('#media-title').html(fileTitle(thumbnail));
    $('#display button[name="download"]').val(thumbnail);
    $('#display button[name="delete"]').val(thumbnail);

	var imageIndex = thumbnails.indexOf(thumbnail);

	// Previous 
	if (imageIndex > 0) {
		prev = thumbnails[imageIndex-1];
        $('#display button[name="prev"]').prop('disabled', false);
        $('#display button[name="prev"]').unbind();
        $('#display button[name="prev"]').click(function(){load_preview(prev);});	
        if (fileExtension(imageFromThumbnail(prev)) == 'jpg') {
			preloadImage(mediaBase + imageFromThumbnail(prev));
		}
	} else {
		prev = null;
        $('#display button[name="prev"]').prop('disabled', true);
	}

	// Next
	if (imageIndex >= 0 && imageIndex < thumbnails.length - 1) {
		next = thumbnails[imageIndex+1];
        $('#display button[name="next"]').prop('disabled', false);
        $('#display button[name="next"]').unbind();
        $('#display button[name="next"]').click(function(){load_preview(next);});
        if (fileExtension(imageFromThumbnail(next)) == 'jpg') {
			preloadImage(mediaBase + imageFromThumbnail(next));
		}
	} else {
		next = null;
        $('#display button[name="next"]').prop('disabled', true);
	}

	let mediaURL = mediaBase + imageFromThumbnail(thumbnail);
	if (mediaURL) {
		if (fileExtension(mediaURL) == 'jpg') {
			var media_content = `<a href="${mediaURL}" target="_blank"><img src="${mediaURL}" style="width:${previewWidth}px;"></a>`;
		} else {
			var media_content = `<video style="width:${previewWidth}px;" controls><source src="${mediaURL}" type="video/mp4">Your browser does not support the video tag.</video>`;
		}
        $('#media').html(media_content);
	}

	if (fileType(thumbnail) == 't') {
        $('#display button[name="convert"]').removeClass("d-none");
		$('#display button[name="convert"]').val(thumbnail);
	} else {
        $('#display button[name="convert"]').addClass("d-none");        
		$('#display button[name="convert"]').val();
	}
}

</script>
{% endblock%}